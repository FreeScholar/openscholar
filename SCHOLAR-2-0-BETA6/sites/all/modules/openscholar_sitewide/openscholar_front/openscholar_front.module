<?php

include_once('openscholar_front.features.inc');

function openscholar_front_init(){
  $vsite = vsite_get_vsite();
  if (!$vsite && !drupal_is_front_page() 
      && arg(0) != 'admin'){
    context_set('openscholar', 'section', 'sitewide');
  }

}


/**
 * Implementation of hook_menu_alter
 * We need to do some stuff immediately after
 * the installation if finished; Alter the 'node' callback
 */
function openscholar_front_menu_alter(&$items){
  $items['node']['page callback'] = 'openscholar_front_osboot';
}

function openscholar_front_osboot(){
  $scholar_installed = variable_get('scholar_installed', 0);

  if (! $scholar_installed) {
  	module_load_include('inc', 'openscholar_front', 'openscholar_front_osboot');

    system_theme_data(); // Rebuild theme cache.
    _block_rehash(); // Rebuild block cache.
    views_invalidate_cache(); // Rebuild the views.
    menu_rebuild(); // Rebuild the menu.
    features_rebuild(); // Features rebuild scripts.  	

    //_scholar_testingcontent();
    _vsite_filefield_paths_config();
    _vsite_global_taxonomy();
    _vsite_flags_boot();

    // set some default variables
    _vsite_variables_default();

    //Create Vsite Taxonomies
    _vsite_object_create_taxonomys();

    variable_set('scholar_installed', 1);
    variable_set('site_frontpage', 'welcome');
  }

  drupal_goto('welcome');

}

function openscholar_front_menu(){
  $items = array();
  $items['welcome'] = array(
    'type' => MENU_CALLBACK,
    'title' => '',
    'page callback' => 'openscholar_front_welcome',
    'access arguments' => array(
      'access content'
    ),
    );

  return $items;
}

function openscholar_front_welcome(){
  return '';
}


/**
 * Implementation of hook_block().
 */
function openscholar_front_block($op = 'list', $delta = 0) {
  switch ($op) {
    case 'list':
      $info = array(
        'top_links' => array('info' => t('OpenScholar: Top links')),
        'site_info' => array('info' => t('OpenScholar: Site info')),
        'video_info' => array('info' => t('OpenScholar: Video info')),
        'site_mission' => array('info' => t('OpenScholar: Mission Statement')),
        //'search' => array('info' => t('OpenScholar: Search form')),
      );
      
      return $info;
    case 'view':
      $function = "_openscholar_front_block_{$delta}";
      if (function_exists($function)) {
        return call_user_func($function);
      }
      break;
  }
}

function _openscholar_front_block_top_links(){
  $block = array();
  $block['subject'] = t('');
  $block['content'] = openscholar_front_getyoursitebutton();
  return $block;
}

function _openscholar_front_block_site_info(){
  $block = array();
  $block['subject'] = t('');
  $block['content'] = '<h1>' . variable_get('site_name', 'OpenScholar') . '</h1>';
  return $block;
}

function _openscholar_front_block_video_info(){
  $block = array();
  $block['subject'] = t('');
  $block['content'] =     '<div id="video-link">
    <object width="638" height="359"><param name="allowfullscreen" value="true" /><param name="allowscriptaccess" value="always" /><param name="movie" value="http://vimeo.com/moogaloop.swf?clip_id=9887585&amp;server=vimeo.com&amp;show_title=0&amp;show_byline=0&amp;show_portrait=0&amp;color=00ADEF&amp;fullscreen=1" /><embed src="http://vimeo.com/moogaloop.swf?clip_id=9887585&amp;server=vimeo.com&amp;show_title=0&amp;show_byline=0&amp;show_portrait=0&amp;color=00ADEF&amp;fullscreen=1" type="application/x-shockwave-flash" allowfullscreen="true" allowscriptaccess="always" width="638" height="359"></embed></object>
    </div>';
  return $block;
}

function _openscholar_front_block_site_mission() {
    $block = array();
    if (variable_get('site_mission', false)) {
      $block['subject'] = t('');
      $block['content'] =  variable_get('site_mission', false);
    }
    return $block;
  }

/**
 * Implementation of template_preprocess_hook()
 */
function openscholar_front_getyoursitebutton() {
  if (!module_exists('scholarregister')) return;
  global $user;

  //we always allow admin and users with "vsite create access" to see site registration button.
  //and we allow anonymous users to create a new user account and new site
  if ( node_access('create', variable_get('scholar_content_type', 'vsite' )) || in_array('anonymous user', $user -> roles)) {
    $allow = TRUE;
  }

  // all authenticated users
  else{
    // site-owners
    if ($vsites = vsite_get_vsite_by_owner($user->uid)){
      $allow = scholarregister_vsite_exists_access($vsites);
      $site_link = (count($vsites) > 1) ? 'user' : $vsites[0] -> purl;
    }
    //  non-site owners
    else{
      $allow = TRUE;
    }
  }
  //link for front page button
  return  ($allow) ? l('Get your web site!', 'site/register') : l('Go to your site', $site_link);

}