<?php

include_once('scholar_reader.features.inc');

function scholar_reader_init(){
  drupal_add_css(drupal_get_path('module', 'scholar_reader') .'/theme/scholar-reader.css');
}

/**
 * hook strongarm
 */
function scholar_reader_strongarm(){
  $conf = array();

  $conf["show_preview_changes_feed"] = FALSE;
  $conf["show_diff_inline_feed"] = FALSE;

  $conf['node_options_feed'] = array('status');
  $conf['upload_feed'] = FALSE;

  // Comments
  $conf['comment_feed'] = COMMENT_NODE_DISABLED;

  // Pathauto (optional) settings
  $conf["pathauto_node_feed_pattern"] = "[space-og-path]/feeds/[title-raw]";

  //Max number of feeds to proccess at once (per cron)
  $conf['feeds_schedule_num'] = 30;

  // vertical tabs
  $conf['vertical_tabs_forms']['feed_node_form'] = array('feeds' => FALSE);

  $conf['nodeformscols_field_placements_feed_default'] = unserialize('a:14:{s:5:"title";a:5:{s:6:"region";s:4:"main";s:6:"weight";s:1:"0";s:12:"has_required";b:0;s:5:"title";s:5:"Title";s:6:"hidden";i:0;}s:10:"body_field";a:5:{s:6:"region";s:4:"main";s:6:"weight";s:1:"3";s:12:"has_required";b:0;s:5:"title";N;s:6:"hidden";i:0;}s:4:"menu";a:6:{s:6:"region";s:5:"right";s:6:"weight";s:1:"0";s:12:"has_required";b:0;s:5:"title";s:13:"Menu settings";s:9:"collapsed";i:1;s:6:"hidden";i:0;}s:20:"revision_information";a:3:{s:6:"region";s:5:"right";s:6:"weight";s:1:"3";s:6:"hidden";i:0;}s:16:"comment_settings";a:6:{s:6:"region";s:5:"right";s:6:"weight";s:1:"7";s:12:"has_required";b:0;s:5:"title";s:16:"Comment settings";s:9:"collapsed";i:1;s:6:"hidden";i:0;}s:4:"path";a:6:{s:6:"region";s:5:"right";s:6:"weight";s:1:"6";s:12:"has_required";b:0;s:5:"title";s:17:"URL path settings";s:9:"collapsed";i:1;s:6:"hidden";i:0;}s:7:"options";a:6:{s:6:"region";s:5:"right";s:6:"weight";s:1:"5";s:12:"has_required";b:0;s:5:"title";s:18:"Publishing options";s:9:"collapsed";i:1;s:6:"hidden";i:0;}s:6:"author";a:6:{s:6:"region";s:5:"right";s:6:"weight";s:1:"4";s:12:"has_required";b:0;s:5:"title";s:21:"Authoring information";s:9:"collapsed";i:1;s:6:"hidden";i:0;}s:7:"buttons";a:5:{s:6:"region";s:4:"main";s:6:"weight";s:1:"5";s:12:"has_required";b:0;s:5:"title";N;s:6:"hidden";i:0;}s:4:"book";a:6:{s:6:"region";s:5:"right";s:6:"weight";s:1:"2";s:12:"has_required";b:0;s:5:"title";s:12:"Book outline";s:9:"collapsed";i:1;s:6:"hidden";i:0;}s:8:"taxonomy";a:5:{s:6:"region";s:5:"right";s:6:"weight";s:1:"1";s:12:"has_required";b:0;s:5:"title";N;s:6:"hidden";i:0;}s:5:"feeds";a:4:{s:6:"region";s:4:"main";s:6:"weight";s:1:"1";s:12:"has_required";b:1;s:5:"title";s:4:"Feed";}s:10:"og_nodeapi";a:6:{s:6:"region";s:4:"main";s:6:"weight";s:1:"2";s:12:"has_required";b:0;s:5:"title";s:9:"Web Sites";s:9:"collapsed";i:0;s:6:"hidden";i:0;}s:11:"attachments";a:5:{s:6:"region";s:4:"main";s:6:"weight";s:1:"4";s:12:"has_required";b:0;s:5:"title";s:25:"Attach files to this feed";s:6:"hidden";i:0;}}');

  return $conf;
}


/**
 * Implementation of hook_context_links_alter().
 */
function scholar_reader_context_links_alter(&$links) {
  if (!empty($links['feed'])) {
    $links['feed']['query'] = drupal_get_destination();
  }
}

/**
 * hook vsite_sidgets

 */
function scholar_reader_vsite_widgets(){
  $items = array();
  $items['views_scholar_reader-block_1'] = array(
        'module' => 'views',
        'delta' => 'scholar_reader-block_1',
        'weight' => 20,
        'region' => false,
        'status' => '0',
        'label' => 'List of Feeds',
        'type' => 'context_ui',
      );

  $items['views_scholar_reader-block_2'] = array(
        'module' => 'views',
        'delta' => 'scholar_reader-block_2',
        'weight' => 21,
        'region' => false,
        'status' => '0',
        'label' => 'Latest feed items',
        'type' => 'context_ui',
  );

  $items['scholar_reader_my_twitter_feed'] = array(
        'module' => 'scholar_reader',
        'delta' => 'my_twitter_feed',
        'weight' => 20,
        'region' => false,
        'status' => '0',
        'label' => 'Twitter Feed',
        'type' => 'context_ui',
      );

  return $items;
}

/**
 * Implementation of hook_views_api().
 */
function scholar_reader_views_api() {
  return array(
    'api' => 2,
    'path' => drupal_get_path('module', 'scholar_reader') .'/views',
  );
}

/**
 * Implementation of hook_data_views_handlers_alter().
 */
function scholar_reader_data_views_handlers_alter(&$handlers) {
  dpm($handlers);
  $handlers['field']['scholar_reader_handler_field_description'] = 'scholar_reader_handler_field_description';
}



/// the code below was used for feedapi. remove ?



/**
 * Implementation of hook_form_alter().
 * Used to add validation to the feed addition
 */
function scholar_reader_form_alter(&$form, $form_state, $form_id) {
  // Content type form.
  if ($form_id == 'feed_node_form' && $form['type']['#value'] == 'feed') {
    $form['#validate'][] = 'scholar_reader_feed_validate';
  }
}

/**
 * Validate the feed
 *
 * @param $form
 * @param $form_state
 */
function scholar_reader_feed_validate($form, &$form_state) {
  if (!strlen($form_state['values']['feeds']['FeedsHTTPFetcher']['source'])) {
    return;
  }

  $form_state['values']['feeds']['FeedsHTTPFetcher']['source'] = trim($form_state['values']['feeds']['FeedsHTTPFetcher']['source']);

  $form_state['values']['feeds']['FeedsHTTPFetcher']['source'] = str_ireplace("feed:http://","http://",$form_state['values']['feeds']['FeedsHTTPFetcher']['source']); //For Safari Users

  $form_state['values']['feeds']['FeedsHTTPFetcher']['source'] = str_ireplace("feed://","http://",$form_state['values']['feeds']['FeedsHTTPFetcher']['source']); //For Safari Users

  $success = (valid_url($form_state['values']['feeds']['FeedsHTTPFetcher']['source'],true) && ($status = drupal_http_request($form_state['values']['feeds']['FeedsHTTPFetcher']['source'])) && !strlen($status->error));
  if(!$success){
  	form_error($form, t('Can\'t connect to '.$form_state['values']['feeds']['FeedsHTTPFetcher']['source'].'. Invalid feed URL, please check that the URL is valid.'), 'error');
  }
}

/**
 * hook default__contexts_alter
 */
function scholar_reader_context_default_contexts_alter(&$contexts){

  $vsite = vsite_get_vsite();
  if(!$vsite || !strlen($vsite->settings['reader']['twitter_username'])){
    unset($contexts['scholar-feature-front']->block['scholar_reader_my_twitter_feed']);
    unset($contexts['vsite-section-public']->block['scholar_reader_my_twitter_feed']);
  }//Is there a bio created for this site? If not unset the applicable block


}

/**
 * Implementation of hook_spaces_settings().
 */
function scholar_reader_spaces_settings(){
  return array(
    'reader' => array(
      'class' => 'scholar_reader_settings_reader',
      'file' => drupal_get_path('module', 'scholar_reader') . '/include/scholar_reader.settings.inc'
    ),
  );
}

/**
 * Define the scholar reader blocks with hook block
 */
function scholar_reader_block($op = 'list', $delta = false, $edit = array()) {
  if ($op == 'list') {
    $blocks['my_twitter_feed']['info'] = t('Twitter Updates');
    return $blocks;
  }
  elseif ($op == 'view') {
    switch ($delta) {
      case 'my_twitter_feed':
        return _scholar_reader_twitter_wgt();
    }
  }
}


/**
 * Renders twitter block for users
 */
function _scholar_reader_twitter_wgt(){

	if(!($vsite = vsite_get_vsite()) || !$vsite->feature_access('scholar_software')) return array();

	//Do they have thier feed set?
	if(!strlen($vsite->settings['reader']['twitter_username'])) return array();

	//Fix this? Probably a better way of getting the twitter id..
  $twitterid = str_replace("from:",'',$vsite->settings['reader']['twitter_username']);
	$output = twitter_pull_render ($vsite->settings['reader']['twitter_username']);
  $output .= '<div class="twitter-followme">' . l('Follow me on Twitter','http://twitter.com/' . $twitterid) .'</div>';

	return array('subject' => "Twitter Updates",'content' => $output);
}
